name: 'Send Telegram Notification'
description: 'Send notification to Telegram about deployment status'
inputs:
  status_emoji:
    description: 'Emoji for status (e.g., ‚ùå, ‚úÖ, üöÄ)'
    required: false
    default: '‚ùå'
  status_text:
    description: 'Status text (e.g., "–û—à–∏–±–∫–∞", "–£—Å–ø–µ—à–Ω–æ")'
    required: true
  details:
    description: 'Additional details about the error or success'
    required: false
    default: '–ù–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏'
  step_name:
    description: 'Name of the step that failed/succeeded'
    required: false
    default: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —à–∞–≥'
  image_tag:
    description: 'Docker image tag'
    required: false
    default: 'unknown'
  environment:
    description: 'Environment name'
    required: false
    default: 'stage'
  domain:
    description: 'Domain name'
    required: false
    default: 'stage.skillcrm.ru'
  bot_token:
    description: 'Telegram bot token (pass from workflow secrets)'
    required: true
  chat_id:
    description: 'Telegram chat id (pass from workflow secrets)'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Send Telegram Message
      shell: bash
      run: |
        # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
        echo "üîç Debug Telegram notification:"
        echo "Bot token set: $([[ -n "${{ inputs.bot_token }}" ]] && echo "YES" || echo "NO")"
        echo "Chat ID set: $([[ -n "${{ inputs.chat_id }}" ]] && echo "YES" || echo "NO")"
        echo "Status emoji: ${{ inputs.status_emoji }}"
        echo "Status text: ${{ inputs.status_text }}"
        echo "Environment: ${{ inputs.environment }}"
        echo "Domain: ${{ inputs.domain }}"
        echo "Image tag: ${{ inputs.image_tag }}"
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        MESSAGE="${{ inputs.status_emoji }} *${{ inputs.status_text }}!*"
        MESSAGE="${MESSAGE}\n\nüåç *–û–∫—Ä—É–∂–µ–Ω–∏–µ:* ${{ inputs.environment }}"
        MESSAGE="${MESSAGE}\nüåê *–î–æ–º–µ–Ω:* https://${{ inputs.domain }}"
        MESSAGE="${MESSAGE}\nüê≥ *–û–±—Ä–∞–∑:* \`${{ inputs.image_tag }}\`"
        MESSAGE="${MESSAGE}\nüìù *–ö–æ–º–º–∏—Ç:* \`${{ github.sha }}\`"
        MESSAGE="${MESSAGE}\nüë§ *–ê–≤—Ç–æ—Ä:* ${{ github.actor }}"
        MESSAGE="${MESSAGE}\n‚è∞ *–í—Ä–µ–º—è:* $(date '+%d.%m.%Y %H:%M:%S')"
        MESSAGE="${MESSAGE}\n\nüîç *–î–µ—Ç–∞–ª–∏:* ${{ inputs.details }}"
        
        echo "üì§ Sending message to Telegram..."
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ Telegram
        RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.telegram.org/bot${{ inputs.bot_token }}/sendMessage" \
          -d chat_id="${{ inputs.chat_id }}" \
          -d text="$MESSAGE" \
          -d parse_mode="Markdown" \
          -d disable_web_page_preview=true)
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
        
        echo "üì° Telegram API Response:"
        echo "HTTP Code: $HTTP_CODE"
        echo "Response Body: $RESPONSE_BODY"
        
        if [ "$HTTP_CODE" = "200" ]; then
          echo "‚úÖ Telegram message sent successfully!"
        else
          echo "‚ùå Failed to send Telegram message. HTTP Code: $HTTP_CODE"
          echo "Response: $RESPONSE_BODY"
          exit 1
        fi
